#!/usr/bin/env python

import os
import sys
import json
import requests

BASE_URL = 'https://riskdiscovery.com'
DETECTED_CODE = 406
TESTS_PATH = 'tests/'
CVE_TESTS = os.listdir(TESTS_PATH)

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def get_data_file(file):
    with open(file) as f:
        data = f.read()

    return data

for name in CVE_TESTS:
    description = ''
    reference = ''

    print('{}{}{}'.format(bcolors.WARNING, name, bcolors.ENDC))

    if os.path.isfile('tests/{}/description.txt'.format(name)):
        with open('tests/{}/description.txt'.format(name)) as f:
            description = f.read()

        print(description)

    if not os.path.isfile('tests/{}/test.json'.format(name)):
        print  "{}\tTests not found for {}{}".format(bcolors.FAIL, name, bcolors.ENDC)

    else:
        with open('tests/{}/test.json'.format(name)) as f:
            tests = json.load(f)
        
        for test in tests:
            if test['Method'].upper() == 'POST':

                if 'Data' in test:
                    data = test['Data']

                if 'Data-File' in test:
                    data = get_data_file('tests/{}/{}'.format(name, test['Data-File']))

                response = requests.post('{}{}'.format(BASE_URL, test['URI']),
                                        headers=test['Headers'],
                                        data=data,
                                        allow_redirects=False)

            elif test['Method'].upper() == 'GET':
                response = requests.get('{}{}'.format(BASE_URL, test['URI']),
                                        headers=test['Headers'],
                                        allow_redirects=False)
            
            if response.status_code == DETECTED_CODE:
                print "{}\tTest passed ({}){}".format(bcolors.OKGREEN, response.status_code, bcolors.ENDC)
            else:
                print  "{}\tTest failed ({}){}".format(bcolors.FAIL, response.status_code, bcolors.ENDC)
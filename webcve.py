#!/usr/bin/env python3
"""
webcve - A simple framework for sending test payloads for known web CVEs.
"""

import os
import sys
import json
import argparse
import requests
from termcolor import cprint

DETECTED_CODE = 406
TESTS_PATH = 'tests/'
CVE_TESTS = os.listdir(TESTS_PATH)

def get_data_file(localfile):
    """
    Get data file contents
    """
    with open(localfile) as datafile:
        contents = datafile.read()

    return contents

if __name__ == '__main__':
    PARSER = argparse.ArgumentParser(description='Web CVE Tests.')
    PARSER.add_argument('-v', '--verbose', help='Dsiplay verbose output', default=False, action="store_true")
    PARSER.add_argument('-u', '--url', help='Target URL to send payloads to, e.g. https://mytest-site.com.', required=False)
    PARSER.add_argument('-s', '--status-code', help='The server response status code that indicates the payload was succesfully detected.', default="403")
    PARSER.add_argument('-c', '--cve', help='Test specified CVE only, format: CVE-XXXX-XXXXX.')
    PARSER.add_argument('-g', '--group', help='Test group of CVEs (groups defined in groups.json). This will override --cve')
    PARSER.add_argument('-t', '--type', help='Test type of CVEs (types defined in groups.json). This will ovverride --group')
    PARSER.add_argument('-l', '--list', help='List available groups or types.', choices=['group', 'type'])
    ARGS = PARSER.parse_args()

    BASE_URL = ARGS.url

    if ARGS.list is not None:
        if not os.path.isfile('groups.json'):
            cprint("groups.json not found!", "red")
            sys.exit(1)

        with open('groups.json') as f:
            groups = json.load(f)

        dedup = []

        for group in groups:
            if ARGS.list == 'group':
                value = group['name']
            if ARGS.list == 'type':
                value = group['type']

            if value not in dedup:
                print(value)

            dedup.append(value)
        
        sys.exit()

    if ARGS.status_code is not None:
        DETECTED_CODE = ARGS.status_code

    if ARGS.cve is not None:
        CVE_TESTS = [ARGS.cve]

    if ARGS.group is not None:
        CVE_TESTS.clear()

        if not os.path.isfile('groups.json'):
            cprint("groups.json not found!", "red")
            sys.exit(1)

        with open('groups.json') as f:
            groups = json.load(f)

        for group in groups:
            if group['name'] == ARGS.group.lower():
                CVE_TESTS.extend(group['cves'])

    if ARGS.type is not None:
        CVE_TESTS.clear()

        if not os.path.isfile('groups.json'):
            cprint("groups.json not found!", "red")
            sys.exit(1)

        with open('groups.json') as f:
            groups = json.load(f)

        for group in groups:
            if group['type'] == ARGS.type.lower():
                CVE_TESTS.extend(group['cves'])

    for name in CVE_TESTS:
        if ARGS.url is None:
            PARSER.print_help()
            print('webcve.py: error: the following arguments are required: -u/--url')
            sys.exit(1)

        description = ''
        reference = ''

        cprint("{}".format(name), "yellow")

        if ARGS.verbose is True:
            if os.path.isfile('tests/{}/description.txt'.format(name)):
                with open('tests/{}/description.txt'.format(name)) as f:
                    description = f.read()

                    cprint(description, "white")

        if not os.path.isfile('tests/{}/test.json'.format(name)):
            cprint("\tTests not found for {}".format(name), "red")

        else:
            with open('tests/{}/test.json'.format(name)) as f:
                tests = json.load(f)

            for test in tests:
                if test['Method'].upper() == 'POST':

                    if 'Data' in test:
                        data = test['Data']

                    if 'Data-File' in test:
                        data = get_data_file('tests/{}/{}'.format(name, test['Data-File']))

                    if 'File-Upload-File' in test:
                        file_contents = get_data_file('tests/{}/{}'.format(name, test['File-Upload-File']))

                        response = requests.post('{}{}'.format(BASE_URL, test['URI']),
                                                headers=test['Headers'],
                                                files={'files[]': (test['File-Upload-Name'], file_contents)},
                                                allow_redirects=False)
                    else:
                        response = requests.post('{}{}'.format(BASE_URL, test['URI']),
                                                headers=test['Headers'],
                                                data=data,
                                                allow_redirects=False)

                elif test['Method'].upper() == 'GET':

                    if 'Data-File' in test:
                        data = get_data_file('tests/{}/{}'.format(name, test['Data-File']))

                        response = requests.get('{}{}'.format(BASE_URL, test['URI']),
                                                headers=test['Headers'],
                                                data=data,
                                                allow_redirects=False)
                    else:
                        response = requests.get('{}{}'.format(BASE_URL, test['URI']),
                                                headers=test['Headers'],
                                                allow_redirects=False)

                if response.status_code == int(DETECTED_CODE):
                    cprint("\tTest passed ({})".format(response.status_code), "green")
                else:
                    cprint("\tTest failed ({})".format(response.status_code), "red")

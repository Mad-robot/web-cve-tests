#!/usr/bin/env python3
"""
webcve
"""

import os
import json
import argparse
import requests
from termcolor import cprint

BASE_URL = 'https://riskdiscovery.com'
DETECTED_CODE = 406
TESTS_PATH = 'tests/'
CVE_TESTS = os.listdir(TESTS_PATH)

def get_data_file(localfile):
    """
    Get data file contents
    """
    with open(localfile) as datafile:
        contents = datafile.read()

    return contents

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Web CVE Tests.')
    parser.add_argument('-v', help='Dsiplay verbose output', default=False, action="store_true")
    parser.add_argument('-cve', help='Test specified CVE only, format: CVE-XXXX-XXXXX.')
    args = parser.parse_args()

    if args.cve is not None:
        CVE_TESTS = [args.cve]

    for name in CVE_TESTS:
        description = ''
        reference = ''

        cprint("{}".format(name), "yellow")

        if args.v == True:
            if os.path.isfile('tests/{}/description.txt'.format(name)):
                with open('tests/{}/description.txt'.format(name)) as f:
                    description = f.read()

                    print(description)

        if not os.path.isfile('tests/{}/test.json'.format(name)):
            cprint ("\tTests not found for {}".format(name), "red")

        else:
            with open('tests/{}/test.json'.format(name)) as f:
                tests = json.load(f)

            for test in tests:
                if test['Method'].upper() == 'POST':

                    if 'Data' in test:
                        data = test['Data']

                    if 'Data-File' in test:
                        data = get_data_file('tests/{}/{}'.format(name, test['Data-File']))

                    response = requests.post('{}{}'.format(BASE_URL, test['URI']),
                                            headers=test['Headers'],
                                            data=data,
                                            allow_redirects=False)

                elif test['Method'].upper() == 'GET':
                    response = requests.get('{}{}'.format(BASE_URL, test['URI']),
                                            headers=test['Headers'],
                                            allow_redirects=False)

                if response.status_code == DETECTED_CODE:
                    cprint("\tTest passed ({})".format(response.status_code), "green")
                else:
                    cprint("\tTest failed ({})".format(response.status_code), "red")
